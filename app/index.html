<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Traces - 你的运动轨迹整合工具</title>
    <style>
    *{margin:0;padding:0}body,html{height:100%}body{display:flex;justify-content:center;align-items:center;background:#fdfdfd;font-family:"Helvetica Neue","Microsoft Yahei",Arial,sans-serif}.wrapper div{width:350px;margin:30px auto}p{text-align:center;}label{margin-right:10px;font-weight:100}input{font:14px/2 "Helvetica Neue","Microsoft Yahei",Arial,sans-serif}input[type=text]{width:240px;padding:0 5px;border:1px solid #aaa;border-radius:2px;color:#333}input[type=file]{display:inline-flex;font-weight:100;outline:0}#upload{width:120px;margin-bottom:10px;font-size:16px;line-height:2;text-align:center;color:#fff;background-color:#4bb505;border-radius:4px;cursor:pointer}label.must:before{content: '*';margin-left: -6px;color: #f00;}.ak-link{font-size:12px;margin-left:8px;}.issue-link{font-size:12px;color:#aaa}
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h1>Traces</h1>
      <div><label for="city">Step 1:</label><input type="text" id="city" placeholder="请输入设置为中心的城市名"></div>
      <div><label for="title">Step 2:</label><input type="text" id="title" placeholder="请输入想要的网页标题"></div>
      <div>
        <label class="must" for="ak">Step 3:</label><input type="text" id="ak" placeholder="请输入百度地图ak秘钥，必填">
        <a class="ak-link" href="http://lbsyun.baidu.com/apiconsole/key?application=key">更多</a>
      </div>
      <div><label>Step 4:</label><input type="file" multiple id="files" accept=".gpx"></div>
      <div id="upload">Generate!</div>
      <p><a class="issue-link" href="https://github.com/shenlvmeng/Traces-maker/issues/new">联系作者</a></p>
    </div>
    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>
<script type="text/template" id="template">
<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><style>*{margin:0;padding:0;}.locations,div.panel{color:#fff;position:absolute}.hide .curr,.locations.hide{opacity:0}.close,.locations,div.panel{position:absolute}.city,.close{cursor:pointer}#map,body,html{width:100%;height:100%;overflow:hidden;margin:0}div.panel{top:10px;left:20px;width:210px;font:lighter 14px/1.8 'Helvetica Neue','Microsoft Yahei',sans-serif}.panel div{background-color:rgba(63,81,181,.5);margin-bottom:10px;padding-left:5px;border-radius:2px}.panel .curr{background-color:rgba(244,67,54,.5);transition:opacity 1s ease-in-out}.locations{bottom:20px;left:50%;min-width:320px;padding:10px 20px;border-radius:2px;transform:translateX(-50%);font-size:14px;font-weight:lighter;background-color:rgba(63,81,181,.5);box-sizing:border-box;z-index:100;transition:opacity ease-in-out .5s}.locations>div{line-height:1.5}.locations span{line-height:1}.city{text-decoration:underline}.close{right:5px;color:#fdfdfd;top:5px;font-size:18px}.shortcut{width:70px;padding:3px 3px 0 3px;font-family:PingFang SC, Helvetica Neue, Helvetica, Microsoft Yahei;}.shortcut img{max-width:100%;max-height:100%;vertical-align:middle;z-index:500;}.BMapLabel{border:1px solid #eee !important;box-shadow:0 1px 6px rgba(0,0,0,.2);}.shortcut::before{content:'';position:absolute;left:32px;bottom:-5px;width:10px;height:10px;transform:rotate(45deg);background:#fff;z-index:-1;}.shortcut p{padding:5px 0;color:#666;text-align:center;font-weight:600;}.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(55,55,55,.6);z-index:1000;display:flex;align-items:center;justify-content:space-around;padding:30px;transition:opacity .5s;}.hidden{opacity:0;pointer-events:none;}.image-original{max-width:50%;}.image-original img{max-height:520px;max-width:100%;}.image-info p{color:#fff;font-size:20px;line-height:4;font-weight:100;}.image-info .title{color:#eee;font-weight:400;}.hideBtn{position:absolute;right:40px;top:20px;font-size:30px;color:#fff;cursor:pointer;}.toggle-images{position:absolute;top:40px;right:10px;padding:6px 15px;font-size:12px;color:#fff;border-radius:4px;cursor:pointer;}.toggle-images.info{background:#16be6b;}.toggle-images.error{background:#ed4040;}</style><title><%=title%></title></head><body><div id="map"></div><div class="panel hide" id="panel"><div>总里程：<span id="distance"></span> km</div><div>总时间：<span id="time"></span></div><div class="curr">当次里程：<span id="curr_distance"></span> km</div><div class="curr">运动时间：<span id="curr_time"></span></div><div class="curr">出发时间：<span id="start_time"></span></div></div><div class="locations">我去过的地方<div class="province">省份：<span id="provinces"></span></div><div class="cities">城市：<span id="cities"></span></div><span class="close" id="close">×</span></div><div class="modal hidden" id="modal"><div class="image-original"><img src="" id="image"></div><div class="image-info"><p class="title">详情</p><p>经度：<span id="longitude"></span> N</p><p>纬度：<span id="latitude"></span> E</p><p>海拔：<span id="altitude"></span>m</p><p>摄于：<span id="create-time"></span></p></div><div class="hideBtn" id="hide">×</div></div><div id="toggle" class="toggle-images error">关闭图片展示</div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js">&lt;/script><script src="https://api.map.baidu.com/api?v=2.0&ak=<%=key%>">&lt;/script><script>
    !function(){const t=3.141592653589793,e=52.35987755982988;function n(e,n){const a=6378245,i=.006693421622965943;let o=function(e,n){let a=2*e-100+3*n+.2*n*n+.1*e*n+.2*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*t)+20*Math.sin(2*e*t))/3,a+=2*(20*Math.sin(n*t)+40*Math.sin(n/3*t))/3,a+=2*(160*Math.sin(n/12*t)+320*Math.sin(n*t/30))/3}(n-105,e-35),s=function(e,n){let a=300+e+2*n+.1*e*e+.1*e*n+.1*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*t)+20*Math.sin(2*e*t))/3,a+=2*(20*Math.sin(e*t)+40*Math.sin(e/3*t))/3,a+=2*(150*Math.sin(e/12*t)+300*Math.sin(e/30*t))/3}(n-105,e-35);const r=e/180*t;let c=Math.sin(r);c=1-i*c*c;const l=Math.sqrt(c);return{lat:o=180*o/(a*(1-i)/(c*l)*t),lon:s=180*s/(a/l*Math.cos(r)*t)}}function a(t,e){if(o(t,e))return{lat:t,lon:e};const a=n(t,e);return{lat:t+a.lat,lon:e+a.lon}}function i(e,n,a,i){let o=Math.cos(e*t/180)*Math.cos(a*t/180)*Math.cos((n-i)*t/180)+Math.sin(e*t/180)*Math.sin(a*t/180);return o>1&&(o=1),o<-1&&(o=-1),6371e3*Math.acos(o)}function o(t,e){return e<72.004||e>137.8347||(t<.8293||t>55.8271)}function s({lat:t,lon:n}){let i=a(t,n);return function(t,n){const a=n,i=t,o=Math.sqrt(a*a+i*i)+2e-5*Math.sin(i*e),s=Math.atan2(i,a)+3e-6*Math.cos(a*e),r=o*Math.cos(s)+.0065;return{lat:o*Math.sin(s)+.006,lon:r}}(i.lat,i.lon)}var i=0,r=0,c=null,l=Array.apply(null,Array(<%=length%>)).map(function(t,e){return e+".json"}),d=[],u=[];function h(t){return document.getElementById(t)}function p(t){var e=t.city,n=t.province;n&&-1===d.indexOf(n)&&d.push(n),e&&-1===u.indexOf(e)&&u.push(e),h("provinces").innerText=d.map(function(t){return t.slice(0,-1)}).join(", "),h("cities").innerHTML=u.map(function(t){return"<span class='city'>"+t.slice(0,-1)+"</span>"}).join(", ")}function m(t){return t>31536e3?~~(t/315636e3)+"年 "+m(t%31536e3):t>2592e3?~~(t/2592e3)+"月 "+m(t%2592e3):t>86400?~~(t/86400)+"天 "+m(t%86400):t>3600?~~(t/3600)+"h "+m(t%3600):t>60?~~(t/60)+"m "+m(t%60):t.toFixed(0)+"s"}function M(){c&&(c.setStrokeColor("#3a6bdb"),h("panel").className+=" hide",c=null)}var g=new BMap.Map("map");g.centerAndZoom("<%=city%>"),g.addControl(new BMap.MapTypeControl({mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]})),g.enableScrollWheelZoom(!0),g.addEventListener("click",function(t){M()}),h("cities").addEventListener("click",function(t){(t.target.className="city")&&g.centerAndZoom(t.target.innerText)}),h("close").addEventListener("click",function(t){t.target.parentNode.className+=" hide"}),function t(){var e,n,a;l.length&&(e=l.shift(),n=function(e){e&&t();try{var n=JSON.parse(e);i+=+n.distance,r+=+n.time;var a=n.points.map(function(t){return new BMap.Point(t.lng,t.lat)}),o=new BMap.Polyline(a,{enableMassClear:!1});o.metadata={distance:n.distance,time:n.time,startTime:n.startTime},o.addEventListener("click",function(t){M(),t.target.setStrokeColor("#f44336");var e=t.target.metadata;h("curr_distance").innerText=e.distance,h("curr_time").innerText=m(e.time),h("start_time").innerText=e.startTime,h("panel").className="panel",c=t.target,t.domEvent.stopPropagation()}),g.addOverlay(o),(new BMap.Geocoder).getLocation(a[0],function(t){p(t.addressComponents)}),(new BMap.Geocoder).getLocation(a[~~(a.length/2)],function(t){p(t.addressComponents)}),(new BMap.Geocoder).getLocation(a[a.length-1],function(t){p(t.addressComponents)}),h("distance").innerText=i.toFixed(3),h("time").innerText=m(r)}catch(t){console.warn(t)}},(a=new XMLHttpRequest).open("GET",e,!0),a.onreadystatechange=function(){4===a.readyState&&200===a.status&&n(a.response)},a.send())}();var f=0,v=!0,T=[];function x(t){return document.querySelector(t)}function L(t){return t[0]+t[1]/60+t[2]/3600}function y(){T.forEach(function(t,e){const n=s({lat:t.latitude,lon:t.longitude}),a=new BMap.Point(n.lon,n.lat),i=`<div class="shortcut" title="摄于${t.time}" id="${e}">\n                    <img src='./images/${e}.jpg' />\n                    <p>海拔 ${t.altitude.toFixed(1)}m</p>\n                </div>`,o=new BMap.Label(i,{position:a,offset:new BMap.Size(-38,t.vertical?-134:-95)});g.addOverlay(o)})}!function t(){const e=new Image;e.src=`./images/${f}.jpg`,e.onerror=function(t){y()},e.onload=function(){EXIF.getData(e,function(){T.push({vertical:200===this.height,time:EXIF.getTag(this,"DateTime"),altitude:EXIF.getTag(this,"GPSAltitude").valueOf(),latitude:L(EXIF.getTag(this,"GPSLatitude")),longitude:L(EXIF.getTag(this,"GPSLongitude"))}),t(++f)})}}(),x("#map").addEventListener("click",function(t){let e=t.target;if(e.id||(e=e.parentNode),e.id&&e.id<T.length){const t=T[+e.id];x("#modal").classList.remove("hidden"),x("#altitude").innerText=t.altitude.toFixed(3),x("#longitude").innerText=t.longitude.toFixed(5),x("#latitude").innerText=t.latitude.toFixed(5),x("#image").src=`http://p2worlbdz.bkt.clouddn.com/c_${e.id}.jpg-depress`,x("#create-time").innerText=`${t.time.slice(0,11).replace(/:/g,"-")}${t.time.slice(11)}`}}),x("#hide").addEventListener("click",function(){x("#modal").classList.add("hidden")}),x("#toggle").addEventListener("click",function(){v=!v,this.innerText=v?"关闭图片展示":"开启图片展示",this.className=v?"toggle-images error":"toggle-images info",v?y():g.clearOverlays()})}();
&lt;/script>
&lt;/html></script>
  </body>
</html>
